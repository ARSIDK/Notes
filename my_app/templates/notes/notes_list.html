<!DOCTYPE html>
<html>
<head>
    <title>{% if note %}Редактировать{% else %}Создать{% endif %} заметку</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Ваши существующие стили остаются без изменений */
        .form-container { max-width: 800px; margin: 0 auto; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; border-radius: 10px; }
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px 10px 0 0 !important; }
        .character-count { font-size: 0.8rem; color: #6c757d; text-align: right; }
        .tag-badge { margin-right: 5px; margin-bottom: 5px; cursor: pointer; transition: all 0.3s; }
        .tag-badge.selected { transform: scale(1.1); box-shadow: 0 0 0 2px #007bff; }
        .preview-card { border-left: 4px solid #007bff; background-color: #f8f9fa; transition: all 0.3s; }
        .required-field::after { content: " *"; color: red; }
        .btn-group-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .editor-toolbar { background-color: #f8f9fa; border: 1px solid #dee2e6; border-bottom: none; padding: 8px; border-radius: 5px 5px 0 0; }
        .editor-toolbar button { margin-right: 5px; margin-bottom: 5px; }
        @media (max-width: 768px) { .btn-group-actions { flex-direction: column; } .btn-group-actions .btn { width: 100%; } }
        .error-message { color: #dc3545; font-size: 0.875em; margin-top: 0.25rem; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Сообщения об успехе/ошибках -->
        {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="form-container">
            <!-- Основная карточка формы -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">
                            <i class="fas fa-{% if note %}edit{% else %}plus{% endif %} me-2"></i>
                            {% if note %}Редактировать заметку{% else %}Создать новую заметку{% endif %}
                        </h3>
                        <span class="badge bg-light text-dark">
                            <i class="fas fa-hashtag me-1"></i>{% if note %}{{ note.id }}{% else %}Новая{% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="card-body">
                    <form method="post" id="noteForm">
                        {% csrf_token %}
                        
                        <!-- Вывод ошибок формы -->
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <strong>Пожалуйста, исправьте ошибки:</strong>
                            <ul class="mb-0">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Заголовок -->
                        <div class="mb-4">
                            <label for="id_title" class="form-label required-field">
                                <i class="fas fa-heading me-1"></i>Заголовок заметки
                            </label>
                            <input type="text" 
                                   name="title" 
                                   id="id_title" 
                                   class="form-control {% if form.title.errors %}is-invalid{% endif %}" 
                                   value="{{ form.title.value|default:'' }}"
                                   maxlength="100"
                                   placeholder="Введите заголовок заметки"
                                   required>
                            {% if form.title.errors %}
                                <div class="error-message">{{ form.title.errors.0 }}</div>
                            {% endif %}
                            <div class="character-count">
                                <span id="titleCount">0</span>/100 символов
                            </div>
                        </div>

                        <!-- Содержание с редактором -->
                        <div class="mb-4">
                            <label for="id_content" class="form-label required-field">
                                <i class="fas fa-align-left me-1"></i>Содержание заметки
                            </label>
                            
                            <!-- Панель инструментов редактора -->
                            <div class="editor-toolbar">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('bold')" title="Жирный">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('italic')" title="Курсив">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('underline')" title="Подчеркивание">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('h1')" title="Заголовок 1">
                                        H1
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('h2')" title="Заголовок 2">
                                        H2
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('h3')" title="Заголовок 3">
                                        H3
                                    </button>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('list-ul')" title="Маркированный список">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('list-ol')" title="Нумерованный список">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('link')" title="Ссылка">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('code')" title="Код">
                                    <i class="fas fa-code"></i>
                                </button>
                            </div>
                            
                            <textarea name="content" 
                                      id="id_content" 
                                      class="form-control {% if form.content.errors %}is-invalid{% endif %}" 
                                      rows="8" 
                                      placeholder="Введите содержание заметки..."
                                      required>{{ form.content.value|default:'' }}</textarea>
                            {% if form.content.errors %}
                                <div class="error-message">{{ form.content.errors.0 }}</div>
                            {% endif %}
                            <div class="character-count">
                                <span id="contentCount">0</span> символов
                            </div>
                            <small class="text-muted">Поддерживается Markdown-разметка. Используйте панель инструментов для быстрого форматирования.</small>
                        </div>

                        <!-- Даты и теги -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="id_due_date" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>Срок выполнения
                                </label>
                                <input type="datetime-local" 
                                       name="due_date" 
                                       id="id_due_date" 
                                       class="form-control" 
                                       value="{{ form.due_date.value|date:'Y-m-d\TH:i'|default:'' }}">
                                <div class="form-text">
                                    Оставьте пустым, если срок не установлен
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_tags" class="form-label">
                                    <i class="fas fa-tags me-1"></i>Теги
                                </label>
                                <input type="text" 
                                       name="tags" 
                                       id="id_tags" 
                                       class="form-control" 
                                       value="{{ form.tags.value|default:'' }}"
                                       placeholder="работа, личное, важное">
                                <div class="form-text">
                                    Вводите теги через запятую или выбирайте из популярных
                                </div>
                                
                                <!-- Быстрые теги -->
                                <div class="mt-2">
                                    <small class="text-muted">Быстрые теги:</small>
                                    {% for tag in popular_tags %}
                                    <span class="badge bg-light text-dark tag-badge" onclick="addTag('{{ tag }}')">
                                        {{ tag }}
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Дополнительные настройки -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="id_is_completed" name="is_completed"
                                           {% if form.is_completed.value %}checked{% endif %}>
                                    <label class="form-check-label" for="id_is_completed">
                                        <i class="fas fa-check-circle me-1"></i>Заметка завершена
                                    </label>
                                </div> 
                                
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="id_pinned" name="pinned"
                                           {% if note.pinned or form.pinned.value %}checked{% endif %}>
                                    <label class="form-check-label" for="id_pinned">
                                        <i class="fas fa-thumbtack me-1"></i>Закрепить заметку
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_priority" class="form-label">Приоритет</label>
                                <select class="form-select" id="id_priority" name="priority">
                                    <option value="low" {% if form.priority.value == 'low' %}selected{% endif %}>Низкий</option>
                                    <option value="medium" {% if not form.priority.value or form.priority.value == 'medium' %}selected{% endif %}>Средний</option>
                                    <option value="high" {% if form.priority.value == 'high' %}selected{% endif %}>Высокий</option>
                                </select>
                            </div>
                        </div>

                        <!-- Информация о заметке (только при редактировании) -->
                        {% if note %}
                        <div class="alert alert-info">
                            <div class="row">
                                <div class="col-md-4">
                                    <strong><i class="fas fa-calendar-plus me-1"></i>Создана:</strong><br>
                                    {{ note.created_at|date:"d.m.Y H:i" }}
                                </div>
                                <div class="col-md-4">
                                    <strong><i class="fas fa-edit me-1"></i>Изменена:</strong><br>
                                    {{ note.updated_at|date:"d.m.Y H:i" }}
                                </div>
                                <div class="col-md-4">
                                    <strong><i class="fas fa-user me-1"></i>Автор:</strong><br>
                                    {{ note.author.get_full_name|default:note.author.username }}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Предпросмотр заметки -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-eye me-1"></i>Предпросмотр
                            </label>
                            <div class="preview-card p-3">
                                <h5 id="previewTitle">{{ form.title.value|default:"Заголовок заметки" }}</h5>
                                <div class="text-muted small mb-2">
                                    <span id="previewDate">{% if note %}{{ note.created_at|date:"d.m.Y H:i" }}{% else %}Только что{% endif %}</span>
                                    {% if form.due_date.value %}
                                    • <span id="previewDueDate">Срок: {{ form.due_date.value|date:"d.m.Y H:i" }}</span>
                                    {% endif %}
                                </div>
                                <hr>
                                <div id="previewContent">
                                    {{ form.content.value|default:"Содержание заметки..."|linebreaks }}
                                </div>
                                <div id="previewTags" class="mt-2">
                                    <!-- Теги будут добавляться через JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Кнопки действий -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="btn-group-actions">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-save me-2"></i>
                                    {% if note %}Обновить{% else %}Создать{% endif %}
                                </button>
                                <button type="submit" name="save_and_new" value="true" class="btn btn-outline-success">
                                    <i class="fas fa-plus me-2"></i>Сохранить и создать новую
                                </button>
                                <a href="{% url 'notes_list' %}" class="btn btn-secondary">
                                    <i class="fas fa-times me-2"></i>Отмена
                                </a>
                            </div>
                            
                            {% if note %}
                            <div>
                                <a href="{% url 'note_delete' note.id %}" 
                                   class="btn btn-outline-danger"
                                   onclick="return confirm('Вы уверены, что хотите удалить эту заметку?')">
                                    <i class="fas fa-trash me-2"></i>Удалить
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Подсчет символов
            const titleInput = document.getElementById('id_title');
            const contentInput = document.getElementById('id_content');
            const titleCount = document.getElementById('titleCount');
            const contentCount = document.getElementById('contentCount');
            
            function updateCharacterCount() {
                titleCount.textContent = titleInput.value.length;
                contentCount.textContent = contentInput.value.length;
            }
            
            titleInput.addEventListener('input', updateCharacterCount);
            contentInput.addEventListener('input', updateCharacterCount);
            updateCharacterCount();

            // Обновление предпросмотра
            function updatePreview() {
                document.getElementById('previewTitle').textContent = 
                    titleInput.value || 'Заголовок заметки';
                
                document.getElementById('previewContent').innerHTML = 
                    contentInput.value.replace(/\n/g, '<br>') || 'Содержание заметки...';
                
                // Обновление тегов в предпросмотре
                const tagsInput = document.getElementById('id_tags');
                const previewTags = document.getElementById('previewTags');
                if (tagsInput.value) {
                    const tags = tagsInput.value.split(',').map(tag => tag.trim());
                    previewTags.innerHTML = tags.map(tag => 
                        `<span class="badge bg-secondary me-1">${tag}</span>`
                    ).join('');
                } else {
                    previewTags.innerHTML = '';
                }
            }
            
            titleInput.addEventListener('input', updatePreview);
            contentInput.addEventListener('input', updatePreview);
            document.getElementById('id_tags').addEventListener('input', updatePreview);
            updatePreview();

            // Подтверждение при уходе со страницы
            let formChanged = false;
            const formInputs = document.querySelectorAll('input, textarea, select');
            
            formInputs.forEach(input => {
                input.addEventListener('input', function() {
                    formChanged = true;
                });
            });
            
            window.addEventListener('beforeunload', function(e) {
                if (formChanged) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
            
            document.getElementById('noteForm').addEventListener('submit', function() {
                formChanged = false;
            });
        });

        // Функции форматирования текста
        function formatText(command) {
            const textarea = document.getElementById('id_content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            let formattedText = '';
            
            switch(command) {
                case 'bold':
                    formattedText = `**${selectedText}**`;
                    break;
                case 'italic':
                    formattedText = `*${selectedText}*`;
                    break;
                case 'underline':
                    formattedText = `<u>${selectedText}</u>`;
                    break;
                case 'h1':
                    formattedText = `# ${selectedText}`;
                    break;
                case 'h2':
                    formattedText = `## ${selectedText}`;
                    break;
                case 'h3':
                    formattedText = `### ${selectedText}`;
                    break;
                case 'list-ul':
                    formattedText = selectedText.split('\n').map(line => `- ${line}`).join('\n');
                    break;
                case 'list-ol':
                    formattedText = selectedText.split('\n').map((line, index) => `${index + 1}. ${line}`).join('\n');
                    break;
                case 'link':
                    formattedText = `[${selectedText}](url)`;
                    break;
                case 'code':
                    formattedText = '```\n' + selectedText + '\n```';
                    break;
            }
            
            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start, start + formattedText.length);
            
            // Обновляем предпросмотр
            updatePreview();
        }

        // Функция добавления тега
        function addTag(tag) {
            const tagsInput = document.getElementById('id_tags');
            const currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
            
            if (!currentTags.includes(tag)) {
                if (currentTags.length > 0) {
                    tagsInput.value = currentTags.join(', ') + ', ' + tag;
                } else {
                    tagsInput.value = tag;
                }
            }
            
            updatePreview();
        }

        // Функция обновления предпросмотра (добавлена для полноты)
        function updatePreview() {
            const titleInput = document.getElementById('id_title');
            const contentInput = document.getElementById('id_content');
            const tagsInput = document.getElementById('id_tags');
            
            document.getElementById('previewTitle').textContent = 
                titleInput.value || 'Заголовок заметки';
            
            document.getElementById('previewContent').innerHTML = 
                contentInput.value.replace(/\n/g, '<br>') || 'Содержание заметки...';
            
            const previewTags = document.getElementById('previewTags');
            if (tagsInput.value) {
                const tags = tagsInput.value.split(',').map(tag => tag.trim());
                previewTags.innerHTML = tags.map(tag => 
                    `<span class="badge bg-secondary me-1">${tag}</span>`
                ).join('');
            } else {
                previewTags.innerHTML = '';
            }
        }
    </script>
</body>
</html>